#
# NOTE: THIS DOCKERFILE IS GENERATED VIA "update.sh"
#
# PLEASE DO NOT EDIT IT DIRECTLY.
#
# ------------------------------------------------------------------------------
# Based on a work at https://github.com/docker/docker.
# ------------------------------------------------------------------------------
FROM php:7.0-cli
MAINTAINER Pydio Team <team@pydio.com>

# ------------------------------------------------------------------------------
# Base libraries
# ------------------------------------------------------------------------------
RUN apt-get update && DEBIAN_FRONTEND=noninteractive apt-get install -y \
	locales \
	libcurl4-openssl-dev \
    libgd-tools \
    fontconfig-config \
    fonts-dejavu-core \
	libmcrypt-dev \
    libicu-dev \
    libxml2-dev \
    libfreetype6-dev \
    libpng12-dev \
    libjpeg-dev \
    libldap2-dev \
	libpq-dev \
	&& rm -rf /var/lib/apt/lists/*

# ------------------------------------------------------------------------------
# PHP extensions
# ------------------------------------------------------------------------------
RUN pecl install apcu

RUN docker-php-ext-install exif intl gd json mysqli pgsql mcrypt opcache xml \
    && docker-php-ext-configure gd --with-png-dir=/usr --with-jpeg-dir=/usr \
    && docker-php-ext-configure ldap --with-libdir=lib/x86_64-linux-gnu/ \
    && docker-php-ext-enable apcu

# ------------------------------------------------------------------------------
# Configure locale
# ------------------------------------------------------------------------------
RUN sed -i -e 's/# en_US.UTF-8 UTF-8/en_US.UTF-8 UTF-8/' /etc/locale.gen \
	&& locale-gen en_US.UTF-8
ENV LANG en_US.UTF-8
ENV LANGUAGE en_US:en
ENV LC_ALL en_US.UTF-8

# ------------------------------------------------------------------------------
# Configure php ini
# ------------------------------------------------------------------------------
RUN { \
		echo 'session.save_path=/var/run/pydio'; \
		echo 'output_buffering=Off'; \
		echo 'cgi.fix_pathinfo=0'; \
		echo 'upload_max_filesize=1G'; \
		echo 'post_max_size=1G'; \
		echo 'opcache.enable_cli=1'; \
        echo 'pid=/var/run/php7.0-fpm.pid'; \
        echo 'listen=/var/run/php7.0-fpm.sock'; \
} > /usr/local/etc/php/conf.d/pydio.ini

RUN mkdir -p /var/run/pydio /var/lib/pydio /etc/pydio \
	&& chown www-data:www-data /var/run/pydio \
	&& chown www-data:www-data /var/lib/pydio \
	&& chown www-data:www-data /etc/pydio

# ------------------------------------------------------------------------------
# Install Pydio
# ------------------------------------------------------------------------------
ENV PYDIO_VERSION 7.0.3

RUN curl -fsSL -o pydio-core.tar.gz https://download.pydio.com/pub/core/archives/pydio-core-${PYDIO_VERSION}.tar.gz \
    && tar -xzf pydio-core.tar.gz -C /usr/share \
    && mv /usr/share/pydio-core-${PYDIO_VERSION} /usr/share/pydio \
	&& mv /usr/share/pydio/data /var/lib/pydio/data \
	&& mv /usr/share/pydio/conf /etc/pydio/conf \
	&& chown -R www-data:www-data /var/lib/pydio/data \
	&& sed -i -e 's!.*define("AJXP_CONF_PATH".*!define("AJXP_CONF_PATH", "/etc/pydio/conf");!g' /usr/share/pydio/base.conf.php \
	&& sed -i -e 's!.*define("AJXP_DATA_PATH".*!define("AJXP_DATA_PATH", "/var/lib/pydio/data");!g' /etc/pydio/conf/bootstrap_context.php

##<autogenerated>##
# ------------------------------------------------------------------------------
# Redefine commands.
# ------------------------------------------------------------------------------
ENTRYPOINT [ "php", "/usr/share/pydio/cmd.php" ]
CMD ["--help"]
##</autogenerated>##
